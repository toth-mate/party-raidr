services:
    backend:
        build:
            context: .
            dockerfile: PartyRaidR.Backend/Dockerfile
        container_name: partyraidr-backend
        ports:
            - "8080:8080"
        volumes:
            - ./PartyRaidR.Backend:/app
            - ./PartyRaidR.Shared:/PartyRaidR.Shared
            - ~nuget/packages:/root/.nuget/packages
        user: root
        command: dotnet watch run --urls http://0.0.0.0:8080
        environment:
            - ASPNETCORE_ENVIRONMENT=Development
            - ConnectionStrings__DefaultConnection=Server=db;Port=3306;Database=partyraidrdb;Uid=partyuser;Pwd=password;
        depends_on:
            db:
                condition: service_started
    db:
        image: mysql:8.0
        volumes:
            - db-data:/var/lib/mysql
        container_name: partyraidr-database
        ports:
            - "3306:3306"
        environment:
            - MYSQL_ROOT_PASSWORD=password
            - MYSQL_DATABASE=partyraidrdb
            - MYSQL_USER=partyuser
            - MYSQL_PASSWORD=password
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p", "password"]
            timeout: 20s
            retries: 10
    web:
        build:
            context: ./PartyRaidR.Web
            dockerfile: Dockerfile
        container_name: partyraidr-frontend
        ports:
        - "5173:5173"
        volumes:
            - ./PartyRaidR.Web:/app
            - /app/node_modules
        environment:
            - VITE_API_URL=http://localhost:8080/api
        depends_on:
            - backend
volumes:
    db-data: